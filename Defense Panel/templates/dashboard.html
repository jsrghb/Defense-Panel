<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Defense Panel</title>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --sidebar-width: 0px;
            --primary-color: #3b82f6;
            --bg-color: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Top Navbar */
        .top-navbar {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Cards */
        .card {
            border: none !important;
            border-radius: 0.75rem;
            box-shadow: none !important;
            background: white;
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        
        .stat-card {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* Tables */
        .table thead th {
            background-color: #f9fafb;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Timeline */
        .timeline-item {
            padding: 1rem 0;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }
        .timeline-item:last-child { border-bottom: none; }

    </style>
</head>
<body>

<!-- Main Content -->
<div class="main-content" id="content">
    <!-- Top Navbar -->
    <div class="top-navbar">
        <div class="d-flex align-items-center gap-2">
            <h5 class="mb-0 fw-bold text-secondary">DEFENSE PANEL</h5>
        </div>
        <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-outline-primary me-3" onclick="fetchData()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button>
            <span class="badge bg-light text-dark border me-3" id="lastUpdate"><i class="bi bi-clock me-1"></i> --:--</span>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-person-circle me-1"></i> Admin
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/logout">Sair</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container-fluid p-3 d-flex flex-column overflow-hidden" style="flex: 1;">
        <div class="row flex-grow-1 overflow-hidden g-3">
            
            <!-- Left Column: Stats, Charts & Events (Compact) -->
            <div class="col-lg-3 d-flex flex-column h-100 gap-3">
                
                <!-- KPIs Compact -->
                <div class="card mb-0 flex-shrink-0">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small fw-bold">TOTAL</span>
                            <span class="fw-bold fs-4" id="totalCameras">0</span>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="p-2 bg-success bg-opacity-10 rounded text-center">
                                    <small class="text-success fw-bold d-block" style="font-size: 0.65rem;">ONLINE</small>
                                    <span class="fw-bold text-success" id="totalOnline">0</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-danger bg-opacity-10 rounded text-center">
                                    <small class="text-danger fw-bold d-block" style="font-size: 0.65rem;">OFFLINE</small>
                                    <span class="fw-bold text-danger" id="totalOffline">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Stacked -->
                <div class="card mb-0 flex-shrink-0">
                    <div class="card-body p-3">
                        <h6 class="card-title text-muted small fw-bold mb-2">STATUS GLOBAL</h6>
                        <div style="height: 120px; position: relative;">
                            <canvas id="donutChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Events -->
                <div class="card flex-grow-1 overflow-hidden mb-0">
                    <div class="card-header bg-white py-2">
                        <h6 class="m-0 fw-bold small">Eventos Recentes</h6>
                    </div>
                    <div class="card-body p-0 overflow-auto">
                        <div id="eventsList" class="p-2">
                            <div class="text-center text-muted py-4 small">Carregando...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Main Data (Areas & Devices) -->
            <div class="col-lg-9 d-flex flex-column h-100 gap-3">
                
                <!-- Area Health (Top) -->
                <div class="card mb-0 flex-shrink-0" style="height: 35%;">
                    <div class="card-header bg-white py-2">
                        <h6 class="m-0 fw-bold">Saúde das Áreas</h6>
                    </div>
                    <div class="card-body overflow-auto">
                        <div id="areaHealthContainer" class="row g-3">
                            <div class="col-12 text-center text-muted py-4">Carregando dados...</div>
                        </div>
                    </div>
                </div>

                <!-- Devices Table (Bottom - Expanded) -->
                <div class="card mb-0 flex-grow-1 overflow-hidden">
                    <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h6 class="m-0 fw-bold">Dispositivos</h6>
                        <div class="d-flex gap-2">
                            <select id="typeFilter" class="form-select form-select-sm" style="width: auto; max-width: 180px;"><option value="">Todos os Tipos</option></select>
                            <select id="areaFilter" class="form-select form-select-sm" style="width: auto; max-width: 160px;"><option value="">Todas as Áreas</option></select>
                            <select id="deviceFilter" class="form-select form-select-sm" style="width: auto; max-width: 200px;"><option value="">Todos os Dispositivos</option></select>
                            <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Buscar...">
                        </div>
                    </div>
                    <div class="table-responsive flex-grow-1">
                        <table class="table table-hover align-middle mb-0 table-sm" id="devicesTable">
                            <thead class="sticky-top bg-white">
                                <tr>
                                    <th class="ps-3">Nome</th>
                                    <th>Tipo</th>
                                    <th>Área</th>
                                    <th>IP</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="devicesTableBody">
                                <!-- JS Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- Charts Initialization ---
    const donutCtx = document.getElementById('donutChart').getContext('2d');

    let donutChart = new Chart(donutCtx, {
        type: 'doughnut',
        data: { labels: ['Online', 'Offline'], datasets: [{ data: [0, 0], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, cutout: '70%' }
    });

    // --- Data Fetching ---
    async function fetchData() {
        try {
            const [devRes, evtRes] = await Promise.all([
                fetch('/devices'),
                fetch('/events')
            ]);

            if (devRes.ok) updateDevices(await devRes.json());
            if (evtRes.ok) updateEvents(await evtRes.json());

            const now = new Date();
            document.getElementById('lastUpdate').innerHTML = `<i class="bi bi-clock me-1"></i> ${now.toLocaleTimeString()}`;
        } catch (err) {
            console.error("Erro ao atualizar:", err);
        }
    }

    function updateDashboardStats(devices) {
        let totalOnline = 0, totalOffline = 0;
        const areaCounts = {};
        const areaHealth = {};

        devices.forEach(dev => {
            const isOnline = dev.status === 'Online';
            if (isOnline) totalOnline++; else totalOffline++;
            
            if (!areaCounts[dev.area]) areaCounts[dev.area] = 0;
            if (!isOnline) areaCounts[dev.area]++;

            if (!areaHealth[dev.area]) areaHealth[dev.area] = { total: 0, online: 0 };
            areaHealth[dev.area].total++;
            if (isOnline) areaHealth[dev.area].online++;
        });

        // Update KPIs
        document.getElementById('totalCameras').innerText = devices.length;
        document.getElementById('totalOnline').innerText = totalOnline;
        document.getElementById('totalOffline').innerText = totalOffline;

        // Update Donut
        donutChart.data.datasets[0].data = [totalOnline, totalOffline];
        donutChart.update();

        // Update Area Health List
        const healthData = Object.entries(areaHealth).map(([area, stats]) => ({
            area,
            percent: stats.total > 0 ? (stats.online / stats.total) * 100 : 0,
            online: stats.online,
            total: stats.total
        }));

        // Sort: Lowest % first
        healthData.sort((a, b) => a.percent - b.percent);

        const currentAreaFilter = document.getElementById('areaFilter').value;

        document.getElementById('areaHealthContainer').innerHTML = healthData.map(item => {
            let color = 'bg-success';
            if (item.percent < 50) color = 'bg-danger';
            else if (item.percent < 90) color = 'bg-warning';
            
            const isSelected = currentAreaFilter === item.area;
            const bgClass = isSelected ? 'bg-primary bg-opacity-10 border border-primary' : 'bg-light border-0';

            return `
                <div class="col-md-6 col-xl-3">
                    <div class="p-2 rounded ${bgClass}" style="cursor: pointer; transition: all 0.2s;" onclick="selectArea('${item.area}')">
                        <div class="d-flex justify-content-between small mb-1">
                            <span class="fw-bold text-dark text-truncate" style="max-width: 75%;" title="${item.area}">${item.area}</span>
                            <span class="fw-bold small">${Math.round(item.percent)}%</span>
                        </div>
                        <div class="progress mb-1" style="height: 6px;">
                            <div class="progress-bar ${color}" role="progressbar" style="width: ${item.percent}%"></div>
                        </div>
                        <div class="text-end text-muted" style="font-size: 0.7rem;">${item.online}/${item.total} Online</div>
                    </div>
                </div>`;
        }).join('') || '<div class="text-muted text-center py-3">Sem dados</div>';
    }

    function selectArea(areaName) {
        const select = document.getElementById('areaFilter');
        if (select.value === areaName) {
            select.value = ""; // Deselect if already selected
        } else {
            select.value = areaName;
        }
        applyFilters();
    }

    let allDevices = [];
    function updateDevices(list) {
        allDevices = list;
        
        // Populate Type Filter
        const types = [...new Set(list.map(d => d.type || 'Câmera'))].sort();
        const typeSelect = document.getElementById('typeFilter');
        const savedType = localStorage.getItem('defense_typeFilter') || "";
        const currentType = typeSelect.value || savedType;

        typeSelect.innerHTML = '<option value="">Todos os Tipos</option>';
        types.forEach(type => {
            typeSelect.add(new Option(type, type, false, type === currentType));
        });
        if ([...typeSelect.options].some(o => o.value === currentType)) typeSelect.value = currentType;
        else typeSelect.value = "";

        // Populate Area Filter
        const areas = [...new Set(list.map(d => d.area))].sort();
        const areaSelect = document.getElementById('areaFilter');
        const savedArea = localStorage.getItem('defense_areaFilter') || "";
        const currentArea = areaSelect.value || savedArea;
        
        areaSelect.innerHTML = '<option value="">Todas as Áreas</option>';
        areas.forEach(area => {
            areaSelect.add(new Option(area, area, false, area === currentArea));
        });
        if ([...areaSelect.options].some(o => o.value === currentArea)) areaSelect.value = currentArea;
        else areaSelect.value = "";

        // Populate Device Filter
        const deviceSelect = document.getElementById('deviceFilter');
        const savedDevice = localStorage.getItem('defense_deviceFilter') || "";
        const currentDevice = deviceSelect.value || savedDevice;

        deviceSelect.innerHTML = '<option value="">Todos os Dispositivos</option>';
        list.sort((a, b) => a.name.localeCompare(b.name)).forEach(dev => {
            deviceSelect.add(new Option(dev.name, dev.name, false, dev.name === currentDevice));
        });
        if ([...deviceSelect.options].some(o => o.value === currentDevice)) deviceSelect.value = currentDevice;
        else deviceSelect.value = "";

        applyFilters();
    }

    function renderTable(list) {
        const tbody = document.getElementById('devicesTableBody');
        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">Nenhum dispositivo encontrado.</td></tr>';
            return;
        }
        tbody.innerHTML = list.map(dev => {
            const isOnline = dev.status === 'Online';
            return `
            <tr>
                <td class="ps-3 fw-medium text-dark">${dev.name}</td>
                <td><span class="badge bg-light text-secondary border fw-normal">${dev.type || 'Câmera'}</span></td>
                <td><span class="badge bg-light text-secondary border fw-normal">${dev.area}</span></td>
                <td class="text-muted small font-monospace">${dev.ip}</td>
                <td><span class="status-badge ${isOnline ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'}">${dev.status}</span></td>
            </tr>`;
        }).join('');
    }

    // Search Filter
    function applyFilters() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const area = document.getElementById('areaFilter').value;
        const type = document.getElementById('typeFilter').value;
        const device = document.getElementById('deviceFilter').value;

        localStorage.setItem('defense_areaFilter', area);
        localStorage.setItem('defense_typeFilter', type);
        localStorage.setItem('defense_deviceFilter', device);
        
        const filtered = allDevices.filter(d => 
            (d.name.toLowerCase().includes(term) || d.area.toLowerCase().includes(term) || d.ip.includes(term)) &&
            (area === "" || d.area === area) &&
            (type === "" || (d.type || 'Câmera') === type) &&
            (device === "" || d.name === device)
        );
        renderTable(filtered);
        updateDashboardStats(filtered);
    }

    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('areaFilter').addEventListener('change', applyFilters);
    document.getElementById('typeFilter').addEventListener('change', applyFilters);
    document.getElementById('deviceFilter').addEventListener('change', applyFilters);

    function updateEvents(events) {
        const container = document.getElementById('eventsList');
        if (events.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-4 small">Sem eventos recentes.</div>';
            return;
        }
        container.innerHTML = events.map(evt => {
            const isOnline = evt.status === 'Online';
            return `
            <div class="timeline-item">
                <div class="timeline-icon ${isOnline ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'}">
                    <i class="bi ${isOnline ? 'bi-wifi' : 'bi-wifi-off'}"></i>
                </div>
                <div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="fw-bold text-dark small">${evt.name}</span>
                        <span class="badge ${isOnline ? 'bg-success' : 'bg-danger'} rounded-pill" style="font-size: 0.65rem;">${evt.status}</span>
                    </div>
                    <div class="text-muted small mt-1">${evt.area} &bull; ${evt.time}</div>
                </div>
            </div>`;
        }).join('');
    }

    // Init
    fetchData();
    setInterval(fetchData, 10000);
</script>
</body>
</html>